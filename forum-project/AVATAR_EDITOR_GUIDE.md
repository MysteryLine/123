# 🎨 头像编辑功能使用指南

## 功能概述

用户可以直接在浏览器中绘制和裁剪自己的头像，无需上传文件。支持：
- ✏️ **自由绘制** - 使用鼠标绘制头像
- 🎨 **颜色选择** - 支持任意颜色
- 📏 **笔刷调整** - 灵活调整笔刷粗细（1-20px）
- ⭕ **圆形裁剪** - 将绘制的图片裁剪成圆形
- 🎯 **交互式裁剪** - 拖动圆形移动，在边界拖动调整大小
- 💾 **自动保存** - 头像自动保存为 Base64，存储在数据库中

## 使用流程

### 1. 访问头像编辑器

**方式一：从导航栏**
```
导航栏头像 → 下拉菜单 → 🎨 编辑头像
```

**方式二：从个人资料页**
```
个人资料页 → 头像上的 ✏️ 按钮
```

**方式三：直接访问**
```
http://localhost:3000/profile/avatar
```

### 2. 绘制阶段

1. 在画布上使用鼠标自由绘制
2. 调整参数：
   - **颜色**：点击颜色输入框选择喜欢的颜色
   - **笔刷粗细**：使用滑块调整（1-20px）
3. 不满意？点击"🗑️ 清除"重新画

**快捷操作：**
- 按住鼠标拖动：绘制
- 释放鼠标：停止绘制

### 3. 裁剪阶段

点击"➡️ 下一步（裁剪）"进入圆形裁剪模式

#### 调整圆形：
- **移动圆形**：在圆形内部拖动，移动裁剪区域
- **调整大小**：在圆形边界附近拖动，调整圆形大小

#### 完成裁剪：
- 点击"✅ 确认头像"完成编辑
- 点击"⬅️ 返回绘制"返回继续画画

### 4. 保存

点击"✅ 确认头像"后，系统会：
1. 自动上传头像到数据库（Base64 格式）
2. 显示上传进度
3. 自动跳转回个人资料页面
4. 全站头像同时更新（导航栏、个人主页、评论区等）

## 技术细节

### 文件大小限制

- **最大限制**：500KB（Base64 编码后）
- **输出格式**：PNG（透明背景）
- **最终尺寸**：圆形头像，边长 = 圆形直径

### 圆形裁剪参数

- **最小半径**：40px
- **最大半径**：150px
- **默认半径**：80px
- **最小圆心坐标**：(半径, 半径)
- **最大圆心坐标**：(300-半径, 300-半径)

### 绘制参数

- **画布尺寸**：300×300px
- **笔刷范围**：1-20px
- **笔刷风格**：圆形笔尖，圆形连接，圆形端点
- **支持颜色**：所有 HTML5 颜色（十六进制、RGB等）

### 存储方式

```javascript
// 数据库中的格式
{
  _id: ObjectId,
  username: String,
  avatar: String,  // Base64 编码的 PNG 图片
  // 其他字段...
}
```

### Base64 优缺点

**优点：**
- ✅ 无需额外的文件存储服务
- ✅ 直接嵌入数据库，避免外链失效
- ✅ 实时生成，速度快
- ✅ 跨浏览器兼容性好

**缺点：**
- ❌ 数据库体积会增加
- ❌ 大量请求时性能稍差
- ❌ 无法实现图片 CDN 加速

## API 接口

### 上传头像

```http
POST /api/upload/avatar
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "avatarBase64": "data:image/png;base64,iVBORw0KGgoAAAANS..."
}
```

**响应：**
```json
{
  "success": true,
  "message": "头像已更新",
  "user": {
    "_id": "...",
    "username": "...",
    "avatar": "data:image/png;base64,iVBORw0KGgoAAAANS...",
    "email": "..."
  }
}
```

**错误响应：**
```json
{
  "success": false,
  "message": "头像文件过大，请重新上传（最大 500KB）"
}
```

## 常见问题

### Q: 绘制的头像太小/太大？
**A:** 在裁剪阶段调整圆形的大小。在圆形边界拖动可以放大或缩小。

### Q: 绘制出错，想从头开始？
**A:** 点击"🗑️ 清除"按钮清空画布，或在裁剪阶段点击"⬅️ 返回绘制"。

### Q: 头像没有更新？
**A:** 
1. 刷新页面查看是否已更新
2. 清除浏览器缓存
3. 检查网络连接
4. 查看浏览器控制台是否有错误信息

### Q: 头像在某些地方没有显示？
**A:** 可能是以下原因：
- 浏览器缓存问题，清除缓存后刷新
- 数据库中头像数据不完整
- 网络问题，重新上传头像

### Q: 支持上传照片吗？
**A:** 不支持直接上传，但可以在绘制时选择任何颜色和图案来创建独特的头像。

## 后端实现要点

### User 模型
```javascript
{
  avatar: {
    type: String,      // Base64 格式
    default: null,
  }
}
```

### 上传控制器
- 验证用户登录状态
- 检查 Base64 数据大小（≤ 500KB）
- 更新用户头像
- 返回更新后的用户信息

### 前端组件

**AvatarEditor.tsx** (297 行)
- 绘制模式：自由绘制、颜色选择、笔刷调整
- 裁剪模式：圆形交互式调整
- 完成后返回 Base64 数据

**Avatar.tsx** (增强版)
- 支持 editable 属性
- 支持 onEdit 回调
- 显示编辑按钮（✏️）

## 性能优化建议

1. **压缩头像大小**
   - 目前使用 PNG，可考虑 WebP 格式
   - 调整图片质量参数

2. **缓存策略**
   - 存储用户头像的 URL 版本
   - 实现 CDN 加速

3. **异步加载**
   - 大量头像显示时使用懒加载
   - 使用图片占位符

4. **数据库优化**
   - 定期清理无效的 Base64 数据
   - 建立索引加快查询

## 安全考虑

1. ✅ JWT 认证保护
2. ✅ 文件大小限制
3. ✅ Base64 内容验证
4. ✅ 数据库更新权限检查

---

**版本**: v1.0  
**最后更新**: 2025年12月5日  
**状态**: ✅ 生产就绪
